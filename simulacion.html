 <html>
   <head>
   <title>Esta es una pagina web</title>
   <script type="text/javascript">
		var NF1, NF2, NI1, NI2, NE, STP, STL, STPL, STC;//estado
		var M, N, SRC, SRPL, TPPL, TPC; //control
		var T,HV,TF;
		var sumatoriaDemoraPreparacionMaquina, sumatoriaDePermanenciaEnElSistema, sumatoriaDeTiempoOciosoFabricacion,
			sumatoriaDeTiempoOciosoImpresion, sumatoriaDeTiempoOciosoEmpaque1, sumatoriaDeTiempoOciosoEmpaque2;
		var instanteTiempoOciosoFabricacion, instanteTiempoOciosoImpresion, instanteTiempoOciosoEmpaque1, instanteTiempoOciosoEmpaque2;
		var porcentajeDeTiempoUtilizadoEnPreparacionDeMaquinas; //resultados
		
		function inicializacion(){
			debugger;
			NF1 = 0;
			NF2 = 0;
			NI1 = 0; 
			NI2 = 0;
			NE = 0;
			STP = 20;
			STL = 5;
			STPL = TPPL;
			STC = TPC;
			T = 0;
			TF = 100000000;
			HV = 99999;
			sumatoriaDemoraPreparacionMaquina = 0;
			sumatoriaDePermanenciaEnElSistema = 0;
			porcentajeDeTiempoUtilizadoEnPreparacionDeMaquinas = 0;
			instanteTiempoOciosoFabricacion = 0;
			instanteTiempoOciosoImpresion = 0;
			instanteTiempoOciosoEmpaque1 = 0;
			instanteTiempoOciosoEmpaque2 = 0;
			sumatoriaDeTiempoOciosoFabricacion = 0;
			sumatoriaDeTiempoOciosoImpresion = 0;
			sumatoriaDeTiempoOciosoEmpaque1 = 0;
			sumatoriaDeTiempoOciosoEmpaque2 = 0;
		}

		function B1(){


		}


		var llegadaPedidoEv = new Object();
		var terminaImpresionEv = new Object();
		var terminaFabricacionEv = new Object();
		var terminaEmpacado1Ev = new Object();
		var terminaEmpacado2Ev = new Object();
		var reposicionPlasticoEv = new Object(); 
		var reposicionLacaEv = new Object();
		var reposicionPinturaEv = new Object();
		var reposicionCajasEv = new Object();
		var maquinaFabricacion = new Object();
		var maquinaImpresion = new Object();		   
		var eventosFuturos = new Array();
		var colaB1F = new Array();
		var colaB2F = new Array();
		var colaB1I = new Array();
		var colaB2I = new Array();
		var colaBE = new Array();		
	
		maquinaFabricacion.modulo = 0;
		maquinaFabricacion.configuracionPomo = 'B1';
		maquinaFabricacion.cantTipoConsecutivo = M;
		maquinaFabricacion.numeroCola1 = NF1;
		maquinaFabricacion.numeroCola2 = NF2;
		maquinaFabricacion.cola1 = colaB1F;
		maquinaFabricacion.cola2 = colaB2F;
		maquinaFabricacion.demoraDistintoPedido = 4;
		maquinaFabricacion.demoraMismoPedido = 2;
	
		maquinaImpresion.modulo = 0;
		maquinaImpresion.configuracionPomo = 'B1';
		maquinaImpresion.cantTipoConsecutivo = N;
		maquinaImpresion.numeroCola1 = NI1;
		maquinaImpresion.numeroCola2 = NI2;
		maquinaImpresion.cola1 = colaB1I;
		maquinaImpresion.cola2 = colaB2I;
		maquinaImpresion.demoraDistintoPedido = 8;
		maquinaImpresion.demoraMismoPedido = 4;

		var numeroColas = new Array(maquinaFabricacion.numeroCola1,maquinaFabricacion.numeroCola2
									,maquinaImpresion.numeroCola1,maquinaImpresion.numeroCola2,NE);

		llegadaPedidoEv.funcion = llegadaPedido;
		terminaImpresionEv.funcion = terminaImpresion;
		terminaFabricacionEv.funcion = terminaFabricacion;
		terminaEmpacado1Ev.funcion = terminaEmpacado;
		terminaEmpacado2Ev.funcion = terminaEmpacado;
		reposicionPlasticoEv.funcion = reposicionPlastico;
		reposicionLacaEv.funcion = reposicionLaca;
		reposicionPinturaEv.funcion = reposicionPintura;
		reposicionCajasEv.funcion = reposicionCajas;

		eventosFuturos.push(llegadaPedidoEv,terminaImpresionEv ,terminaFabricacionEv ,terminaEmpacado1Ev ,terminaEmpacado2Ev ,
		reposicionPlasticoEv ,reposicionLacaEv ,reposicionPinturaEv ,reposicionCajasEv);


		eventosFuturos.forEach(function(elemento, indice){elemento.tiempo = 0;});
		terminaEmpacado1Ev.tiempo = -1;

		function obtenerEventoFuturoProximo() {
		 
			return eventosFuturos.sort(function(a,b){return a.tiempo - b.tiempo})[0];
		}

		function iniciarSimulacion() {
			
			//srand(time(NULL));
			inicializacion();
			simulacion();
		}


		function simulacion(){
			do{
				eventoFuturo = obtenerEventoFuturoProximo()
				eventoFuturo.funcion(eventoFuturo);
			}
			while(T <= TF);
		}

		function creacionDePedido(){
			pedido = new Object();
			pedido.tipoPomo = obtenerTipoPomo();
			pedido.tamanioPedido = obtenerTamanioPedido();
			actualizarInformacionPedido(pedido);
			return pedido;
		}

		function actualizarInformacionPedido(unPedido){
			if(unPedido.tipoPomo == 'B1'){
				unPedido.consumoPlasticoInd = 3.68 / 1000;
				unPedido.cantidadPorCaja = 1300 ;
				unPedido.consumoLacaPorLote = 150 / 1000;
			}
			else
			{
				unPedido.consumoPlasticoInd = 15.15 / 1000;
				unPedido.cantidadPorCaja = 208;
				unPedido.consumoLacaPorLote = 1000 / 1000;
			}

		}

		function llegadaPedido(){
			sumarPermanenciaEnElSistema(llegadaPedidoEv.tiempo);
			T = llegadaPedidoEv.tiempo;
			llegadaPedidoEv.tiempo = T + obtenerIntervaloPedido();
			unPedido = creacionDePedido();

			if(Math.random() < 0.91)
				llegaPedidoCompleto(unPedido);
			else
				llegaPedidoImpresion(unPedido);
				
		}

		function obtenerIntervaloPedido(){//IP
			var R = Math.random();
			return Math.round((447.1/0.3658) * (Math.pow((Math.log(1/R)),-0.3658) - 1) + 453.69);
		}

		function ubicarEnColaDe(maquina,unPedido){

			if(unPedido.tipoPomo == 'B1'){
				maquina.numeroCola1++;
				maquina.cola1.push(unPedido);
			}else{
				maquina.numeroCola2++;
				maquina.cola2.push(unPedido);
			}
		}

	
		function ubicarEnColaDeEmpaque(unPedido){

			colaBE.push(unPedido);
		}

		function llegaPedidoCompleto(unPedido){
						
			ubicarEnColaDe(maquinaFabricacion,unPedido);

			if(maquinaFabricacion.numeroCola1 + maquinaFabricacion.numeroCola2 == 1){
			
				actualizarEstadoMaquina(maquinaFabricacion);
			
				var demora = obtenerDemoraPreparacion(maquinaFabricacion, obtenerTipoPomoAProducir());

				terminaFabricacionEv.tiempo = T + demora + obtenerDemoraDeFabricacion(unPedido);

				sumatoriaDeTiempoOciosoFabricacion += (T- instanteTiempoOciosoFabricacion); 
			}

		}

		function terminaFabricacion(){

			sumarPermanenciaEnElSistema(terminaFabricacionEv.tiempo);
			T = terminaFabricacionEv.tiempo;

			var pedidoParaImpresion = sacarPedidoTerminadoDe(maquinaFabricacion);
			consumirPlastico(pedidoParaImpresion);
			ubicarEnColaDeImpresion(pedidoParaImpresion);

			if(maquinaFabricacion.numeroCola1 > 0 || maquinaFabricacion.numeroCola2 > 0){
				actualizarEstadoMaquina(maquinaFabricacion);
				var tipoPomoAProducir = obtenerTipoPomoAProducir(maquinaFabricacion);
				var pedidoAFabricar = obtenerPedidoDe(maquinaFabricacion, tipoPomoAProducir);
				var demora = obtenerDemoraPreparacion(maquinaFabricacion, tipoPomoAProducir);
				terminaFabricacionEv.tiempo = T + demora + obtenerDemoraDeFabricacion(pedidoAFabricar);
			}
			else
			{
				instanteTiempoOciosoFabricacion = T;
				terminaFabricacionEv.tiempo = HV;
			}
				
			if(maquinaImpresion.numeroCola1 + maquinaImpresion.numeroCola2 == 1){
				actualizarEstadoMaquina(maquinaImpresion);
				var tipoPomoAProducir = obtenerTipoPomoAProducir(maquinaImpresion);
				var pedidoAImprimir = obtenerPedidoDe(maquinaImpresion, tipoPomoAProducir);
				var demora = obtenerDemoraPreparacion(maquinaImpresion, tipoPomoAProducir);
				terminaImpresionEv.tiempo = T + demora + obtenerDemoraDeImpresion(pedidoAImprimir.tamanioPedido);
			}
			
			if(STPL <= SRPL && reposicionPlasticoEv.tiempo == HV)
				reposicionPlasticoEv.tiempo = T + obtenerDemoraDeRecepcionDePlastico();
			
		}

		function sacarPedidoTerminadoDe(maquina){

			if(maquina.configuracionPomo == 'B1'){
				maquina.numeroCola1--;
				maquina.cola1.shift();
			}else{
				maquina.numeroCola2--;
				maquina.cola2.shift();
			}

		}

		function llegaPedidoImpresion(unPedido){
			
			ubicarEnColaDeImpresion(unPedido);
			if(maquinaImpresion.numeroCola1 + maquinaImpresion.numeroCola2 == 1){
				actualizarEstadoMaquina(maquinaImpresion);

				var demora = obtenerDemoraPreparacion(maquinaImpresion , obtenerTipoPomoAProducir());

				terminaImpresionEv.tiempo = T + demora + obtenerDemoraDeImpresion(unPedido.tamanioPedido);

				sumatoriaDeTiempoOciosoImpresion += (T- instanteTiempoOciosoImpresion);
			}
			
		}

		function terminaImpresion(){
			sumarPermanenciaEnElSistema(terminaImpresionEv.tiempo);
			T = terminaImpresionEv.tiempo;

			var pedidoParaEmpacado = sacarPedidoTerminadoDe(maquinaImpresion);
			consumirPintura(pedidoParaEmpacado.tamanioPedido);
			consumirLaca(pedidoParaEmpacado);
			NE++;

			if(maquinaImpresion.numeroCola1 > 0 || maquinaImpresion.numeroCola2 > 0){

				actualizarEstadoMaquina(maquinaImpresion);
				var tipoPomoAProducir = obtenerTipoPomoAProducir(maquinaImpresion);
				var unPedido = obtenerPedidoDe(maquinaImpresion, tipoPomoAProducir);
				var demora = obtenerDemoraPreparacion(maquinaImpresion, tipoPomoAProducir);
				terminaImpresionEv.tiempo = T  + demora + obtenerDemoraDeImpresion(unPedido.tamanioPedido);
			}
			else {
				instanteTiempoOciosoImpresion = T;
				terminaImpresionEv.tiempo = HV;
			}
			
			if(NE <= 2){
				if(terminaEmpacado1Ev.tiempo == HV){

					terminaEmpacado1Ev.tiempo = T + obtenerDemoraDeEmbalado(pedidoParaEmpacado);
				}
				else
					terminaEmpacado2Ev.tiempo = T + obtenerDemoraDeEmbalado(pedidoParaEmpacado);
			

			}
			else
				ubicarEnColaDeEmpaque(pedidoParaEmpacado);
			
			if(STL <= 20 && reposicionLacaEv.tiempo == HV)
				reposicionLacaEv.tiempo = T + 24*60; 
			
			if(STP <= 5 && reposicionPinturaEv.tiempo == HV)
				reposicionPinturaEv.tiempo = T + 24*60;
		}

		
		function obtenerPedidoAEmpacar(){
			return colaBE.shift();
		}

		function terminaEmpacado(terminaEmpacadoEv){
			sumarPermanenciaEnElSistema(terminaEmpacadoEv.tiempo);
			T = terminaEmpacadoEv.tiempo;
			consumirCajas();
			NE--;
			if(NE > 1){
				var pedidoAEmpacar = obtenerPedidoAEmpacar();
				terminaEmpacadoEv.tiempo = T + obtenerDemoraDeEmbalado(pedidoAEmpacar);
			}else{
				terminaEmpacadoEv.tiempo = HV;
			}
				
			if(STC <= SRC && reposicionCajasEv.tiempo == 99999)
				reposicionCajasEv.tiempo = T + 24*60;				
			
		}

		function reposicionPlastico(){
			sumarPermanenciaEnElSistema(reposicionPlasticoEv.tiempo);
			STPL = STPL + TPP;
			reposicionPlasticoEv.tiempo = HV;
		}

		function reposicionLaca(){
			sumarPermanenciaEnElSistema(reposicionLavaEv.tiempo);
			STL = STL + 20;
			reposicionLavaEv.tiempo = HV;
		}

		function reposicionPintura(){
			sumarPermanenciaEnElSistema(reposicionPinturaEv.tiempo);
			STP = STP + 5;
			reposicionPinturaEv.tiempo = HV;
		}

		function reposicionCajas(){
			sumarPermanenciaEnElSistema(reposicionCajasEv.tiempo);
			STC = STC + TPC;
			reposicionCajasEv.tiempo = HV;
		}
		function obtenerTipoPomo(){
			var R = Math.random();
			if(R < 0.64)
				return 'B2';
			else
				return 'B1';

		}

		function obtenerTamanioPedido(){//CANT
			var R = Math.random();
			return Math.round(4766.5 * Math.sqrt(Math.log(1/Math.pow((1-R),2))));
		}

		function obtenerDemoraDeEmbalado(unPedido){
			var demora = 0;

			if(unPedido.tipoPomo == 'B1')
				funcion = demoraEmbaladoB1; 
			else 
				funcion = demoraEmbaladoB2;
			
			for(var i=0; i < unPedido.tamanioPedido; i++){
				demora=+ funcion();
			}

			return demora;
		};
		
		function demoraEmbaladoB1(){//TE1
			var R = Math.random();
			return Math.round(95.055 / (Math.pow(((1/R) - 1),(1/3.419))) + 26.651);
		}

		function demoraEmbaladoB2(){//TE2
			var R = Math.random();//TODO MODIFICAR, NO ES LA CORRECTA
			return Math.round(95.055 / (Math.pow(((1/R) - 1),(1/3.419))) + 26.651);
		}

		function obtenerDemoraDeFabricacion(unPedido){
			var cantidadDeKilogramosDelPedido = unPedido.tamanioPedido * unPedido.consumoPlasticoInd;
			return cantidadDeKilogramosDelPedido / 10;

		};
		
		function obtenerDemoraDeImpresion(tamanioPedido){//TI
			var demora = 0;
			
			for(var i=0; i< cantidadLotes(tamanioPedido); i++){
			
			demora=+ demoraDeImpresion();
			
			}
			
			return demora;
		};

		function demoraDeImpresion(){
			var R = Math.random();
			return Math.round(32.835 / Math.pow((Math.log(1/R)),(1/2.6808)));
		}
		function consumirPlastico(unPedido){
			STPL =- unPedido.tamanioPedido * unPedido.consumoPlasticoInd;

		};

		function consumirCajas(unPedido){
			STC =- Math.ceil(unPedido.tamanioPedido / unPedido.cantidadPorCaja);

		};
		
		function obtenerConsumoLacaIndividualSegun(unPedido){
			
			return unPedido.consumoLacaPorLote / 1000;

		}
		function obtenerDemoraDeRecepcionDePlastico(){
			return 8*60*2; // TODO está harcadoeado en 2 días, mañana lo corrijo
		}

		function consumirPintura(cantidadPomos){//CONS_PINT
			STP =- cantidadLotes(cantidadPomos) * obtenerCantPinturaPorLote() / 1000;
		}
		
		function cantidadLotes(cantidadPomos){
			return Math.ceil(cantidadPomos/1000);
		}
		
		function obtenerCantPinturaPorLote(){
			var R = Math.random();
			return Math.round((2.6507 * Math.tan(Math.PI * (R-0.5)) + 20.027)/5)*5;
		}

		function consumirLaca(unPedido){
			STL =- unPedido.tamanioPedido * obtenerConsumoLacaIndividualSegun(unPedido.tipoPomo);
		}

		function obtenerDemoraPreparacion(maquina, tipoPomoAProducir){
			
			if(maquina.configuracionPomo != tipoPomoAProducir){
				maquina.modulo = Math.ceil(maquina.modulo/maquina.cantTipoConsecutivo)*maquina.cantTipoConsecutivo + 1;
				maquina.configuracionPomo = tipoPomoAProducir;
				var demora = maquina.demoraDistintoPedido;
			}else{
				maquina.modulo++;
				var demora = maquina.demoraMismoPedido;
			}

			sumatoriaDemoraPreparacionMaquina = sumatoriaDemoraPreparacionMaquina + demora;
			return demora;
		}
		
		function obtenerTipoPomoAProducir(maquina){

			if(maquina.configuracionPomo == 'B1')
				maquina.numeroCola1 > 0 ? 'B1' : 'B2';				
			else
				maquina.numeroCola2 > 0 ? 'B2' : 'B1';					

		}

		function obtenerDemoraMismaCola(maquina){ 
			maquina.modulo++;
			return maquina.demoraMismoPedido;
		}

		function obtenerDemoraDistintaCola(moduloCorrector, maquina){
			maquina.modulo = moduloCorrector;
			return maquina.demoraDistintoPedido;
		}

		function actualizarEstadoMaquina(maquina){
			if(maquina.modulo % maquina.cantTipoConsecutivo*2 < maquina.cantTipoConsecutivo)
				maquina.configuracionPomo = 'B1';			
			else
				maquina.configuracionPomo = 'B2';
		}

		function sumarPermanenciaEnElSistema(tiempoEvento){
			for (var i = 0; i < numeroColas.length; i++) {
    			sumatoriaDePermanenciaEnElSistema += numeroColas[i]*(tiempoEvento - T);
			}
		}

		function calculoDeResultados(){
			porcentajeDeTiempoUtilizadoEnPreparacionDeMaquinas = 
				(sumatoriaDemoraPreparacionMaquina * 100)/sumatoriaDePermanenciaEnElSistema;
		}

   </script>
   </head>
   <body>
   <script>
           document.write(iniciarSimulacion());
   </script>
   </body>
   </html>
